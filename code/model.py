import joblib
import numpy as np
from sklearn.model_selection import StratifiedKFold, cross_val_score


class Model(object):
    """ Model training, cross-validation and predicting. """

    def __init__(self, model=None, X=None, y=None, label=None, inter_path=None, result_path=None):
        self.model = model
        self.X = X
        self.y = y
        self.label = label
        self.inter_path = inter_path
        self.result_path = result_path

    def CrossValidation(self, n_splits):
        cv = StratifiedKFold(n_splits=n_splits)
        cv_scores = cross_val_score(self.model, self.X, self.y, scoring='neg_log_loss', cv=cv)
        print(f"Logloss_mean after {n_splits} folds: {-np.mean(cv_scores):.6f}")

    def Fit(self):
        self.model.fit(self.X, self.y)
        joblib.dump(self.model, f"{inter_path}/model_{self.label}.pkl")

    def Predict(self, test_X):
        model = joblib.load(f"{inter_path}/model_{self.label}.pkl")
        test_y = model.predict_proba(test_X)
        np.save(f"{result_path}/submit_{self.label}.npy", test_y)
        return test_y
